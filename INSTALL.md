# Installation

The artifact consists of four main components:

1. An implementation of `AMOEBA` to find all performance bugs reported in the paper.
2. A spreadsheet named `bugs-found` contains a list of bugs that we reported and additional meta information.
3. A spreadsheet named `mutation-rules` contains a list of mutation rules that `AMOEBA` uses.
4. A spreadsheet named `SQL-features` lists SQL features that `AMOEBA` covers.

They are expected to be usable with minimal effort.


## `AMOEBA`

`AMOEBA` is a toolchain that aims at finding performance bugs in database management systems (DBMSs).

Currently supported DBMSs:
1. PostgreSQL (v12.3)
2. CockroachDB (v20.2.0-alpha)

## Build Instruction
Currently, we test `AMOEBA` on a docker container based on Ubuntu 20.04.3. So we expect `AMOEBA` can be easily set up.
The build commands for `AMOEBA` is as follows:

1. Prerequisites:
```
docker pull icsesub2022/paper360:artifact1
docker run --net=host -it --cpus 8 -m 8G --user postgres -v {/a/directory/in/your/host}:/home/postgres/exp icsesub2022/paper360:artifact1 bash
// after starting and attaching to the docker container, run the following commands: 
cd /workspace
eval "$(direnv hook bash)"
start_pg13.sh
start_cockroach.sh
```
Because the docker image we provide already has both the PostgreSQL and CockroachDB installed, the only scripts that need to be run before launching `AMOEBA` are `start_pg13.sh` and `start_cockroach.sh`. They are used to start PostgreSQL and CockroachDB, respectively. 

2. Build the `MUTATOR` of `AMOEBA`:

This step is only necessary if you make changes to the `MUTATOR`
```
cd /workspace/calcite-fuzzing
./gradlew build -x core:checkstyleMain -x test -x core:checkstyleTest -x core:forbiddenApisTest -x core:autostyleJavaCheck

```

## Run `AMOEBA` with Custom Parameters
`AMOEBA` is configurable, a launch command template looks like the following:
```
$timeout {total_timeout} ./test_driver.py --workers {num_workers} --output {outputfolder} --queries {num_queries_per_worker} --rewriter ./calcite-fuzzing --dbms={dbms_undertest} --validate --num_loops={num_feedbackloops} --feedback={conf_feedback} --dbconf=db_conf_demo.json --query_timeout {per_query_timeout}

```

You can customize the value of the following options:
- {total_timeout}: timeout for the entire run of `AMOEBA` (unit is seconds)
- {workers}: number of parallel workers to invoke `GENERATOR` and `MUTATOR`
- {output}: location to store the intermediate results and bug reports
- {queries}: number of base queries that are generated by each `GENERATOR` instance
- {dbms}: DBMS that `AMOEBA` will evaluate on (i.e., `postgresql` or `cockroachdb`) 
- {num_loops}: number of feedback loops
- {validate}: a boolean argument that decides whether to invoke the `VALIDATOR` after generating the equivalent query pairs
- {feedback}: what types of feedbacks to utilize (i.e., `both`, `none`, `mutator`, or `validator`)
- {query_timeout}: timeout for executing each query (unit is seconds)


For example, you can launch `AMOEBA` with the following command:

```
timeout 3600 ./test_driver.py --workers 1 --output /home/postgres/exp/1 --queries 200 --rewriter ./calcite-fuzzing --dbms=postgresql --validate --num_loops=100 --feedback=none --dbconf=db_conf_demo.json --query_timeout 30
```
If `AMOEBA` is working correctly, you should expect to see the following progress information is printed:
```
start query generator
['mutator.py --prob_table=/home/postgres/test/190156/prob_table_190156.json --db_info=/workspace/amoeba_conf/db_conf_demo.json -s seq --queries 100 1>/home/postgres/test/190156/0/log_sa0 2>/home/postgres/test/190156/0/input.sql']
finish query generator
start query rewriter
['java -cp calcite-core-1.22.0-SNAPSHOT-tests.jar:./*:. org.apache.calcite.test.Transformer /home/postgres/test/190156/0']
finish query rewriter
start validator
begin compare plan cost of equivalent queries
compare plan cost /home/postgres/test/190156/0/out/q20.sql
find plan diff /home/postgres/test/190156/0/out/q20.sql
compare plan cost /home/postgres/test/190156/0/out/q13.sql
find plan diff /home/postgres/test/190156/0/out/q13.sql
compare plan cost /home/postgres/test/190156/0/out/q18.sql
compare plan cost /home/postgres/test/190156/0/out/q23.sql
```
This example command should complete within 20 minutes. You can check the generated intermediate results in `/home/postgres/exp/1`. If `AMOEBA` discovers potential performance bugs, the generated bug report will live at `/home/postgres/exp/1/bugs.md`.

The shortcut CTRL+C can be used to terminate `AMOEBA` manually. Otherwise, `AMOEBA` will terminate either after a specified experiment timeout is reached or after a specified number of base queries have been examined. The option `total_timeout` controls the experiment timeout. The options `workers`,  `queries`, and `num_loops` altogether determine the number of base queries that `AMOEBA` is going to examine.


