# Installation

The artifact consists of four main components:

1. An implementation of `AMOEBA` to find all performance bugs reported in the paper.
2. A spreadsheet containing a list of bugs that we reported and additional meta information.
3. A spreadsheet containing a list of mutation rules that `AMOEBA` uses.
4. A spreadsheet listing SQL features that `AMOEBA` covers.

They are expected to be usable with minimal effort.


## `AMOEBA`

`AMOEBA` is a toolchain that aims at finding performance bugs in database managment systems (DBMSs).

Currently supported DBMSs:
1. PostgreSQL (v12.3)
2. CockroachDB (v20.2.0-alpha)

## Build Instruction
Currently we test `AMOEBA` on a docker container based on Ubuntu 20.04.3. So we expect `AMOEBA` can be easily set up.
The build commands for `AMOEBA` is as follows:

1. Prerequisites:
```
docker pull icsesub2022/paper360:artifact
docker run --net=host -it --user postgres icsesub2022/paper360:artifact bash
// after starting and attaching to the docker container, run the following commands: 
cd /workspace
eval "$(direnv hook bash)"
start_pg13.sh
start_cockroach.sh
```
Because the docker image we provide already has both the PostgreSQL and CockroachDB installed, the only scripts need to be run before launching `AMOEBA` are `start_pg13.sh` and `start_cockroach.sh`. They are used to start PostgreSQL and CockroachDB, respectively. 

2. Build the `MUTATOR` of `AMOEBA`:

This step is only necessary if you make changes to the `MUTATOR`
```
cd /workspace/calcite-fuzzing
./gradlew build -x core:checkstyleMain -x test -x core:checkstyleTest -x core:forbiddenApisTest -x core:autostyleJavaCheck

```

## Run `AMOEBA` with Custom Parameters
`AMOEBA` is highly configurable, a launch command template looks like the following:
```
$timeout {total_timeout} ./test_driver.py --workers {num_workers} --output {outputfolder} --queries {num_queries_per_worker} --user postgres --rewriter ./calcite-fuzzing --dbms={dbms_undertest} --validate --update_time={num_feedbackloops} --feedback={conf_feedback} --dbconf=db_conf_demo.json --timeout {per_query_timeout}

```

You can customize the value of the following options:
- {total_timeout}: timeout for the entire run of `AMOEBA`
- {workers}: number of parallel workers to invoke `GENERATOR` and `MUTATOR`
- {output}: location to store the intermediate results and bug reports
- {queries}: number of base queries that are generated by each `GENERATOR` instance
- {dbms}: DBMS that `AMOEBA` will evaluate on (i.e., `postgresql` or `cockroach`) 
- {num_loops}: number of feedback loops
- {validate}: a boolean argument that decides whether to invoke the `VALIDATOR` after generating the equivalent query pairs
- {feedback}: what types of feedbacks to utilize (i.e., `both`, `none`, `mutator`, or `validator`)
- {query_timeout}: timeout for executing each query 


For example, you can launch `AMOEBA` with the following command:

```
timeout 1800 ./test_driver.py --workers 1 --output ~/testexp --queries 100 --user postgres --rewriter ./calcite-fuzzing --dbms=cockroach --validate --num_loops=0 --feedback=both --dbconf=db_conf_demo.json --timeout 10
```
If `AMOEBA` is working correctly, you should expect to see the following progress information is printed:
```
TODO
```
This command should complete within 10 minutes. You can check the generated intermediate results in `~/testexp`. If `AMOEBA` discovers potential performance bugs, the generated bug report will live at `~/testexp/bugs.md`.

The shortcut CTRL+C can be used to terminate `AMOEBA` manually. Otherwise, `AMOEBA` will terminate either after a specified experiment timeout is reached or after a specified number of base queries have been examined. The option `total_timeout` controls the experiment timeout. The options `workers`,  `queries`, and `num_loops` ultimately determine the number of base queries that `AMOEBA` is going to examine.


